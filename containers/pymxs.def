Bootstrap: docker
# From: continuumio/miniconda3:22.11.1
From: nvidia/cuda:11.8.0-devel-ubuntu20.04

# install python3-pip
# RUN apt update && apt install python3-pip -y

# RUN pip install "jax[cuda11_cudnn86]" -f https://storage.googleapis.com/jax-releases/jax_cuda_releases.html

%setup
  set +e
  git diff -s --exit-code HEAD
  RESP=$?
  set -e
  DIRTY=$(if [ ${RESP} -eq 0 ]; then echo ""; else echo "-dirty"; fi)
  HASH=$(git rev-parse HEAD)${DIRTY}
  echo $HASH > /tmp/pymxs-hash

%files
  ./analysis_scripts /app/analysis_scripts
  ./gym_mxs /app/gym_mxs
  ./inertia /app/inertia
  ./models /app/models
  ./processing_scripts /app/processing_scripts
  ./pyaerso /app/pyaerso
  ./pymxs_sbx_run.py /app/pymxs_sbx_run.py
  ./conda-spec.txt /app/conda-spec.txt
  /tmp/pymxs-hash /app/pymxs-hash

%post
  # Create the conda env & source at runtime
#   conda create --name pymxs --file /app/conda-spec.txt
#   echo ". /opt/conda/etc/profile.d/conda.sh" >> $APPTAINER_ENVIRONMENT
#   echo "conda activate pymxs" >> $APPTAINER_ENVIRONMENT

  # Create envvar to signal commit hash
#   echo "export PYMXS_COMMIT=$(cat /app/pymxs-hash)" >> $APPTAINER_ENVIRONMENT

  # Install the gym enviroment in the conda env

  apt update && apt install python3-pip -y
  bash -c "
    # Install the mxs gym environment into the conda environment
    cd /app/gym_mxs
    python3 setup.py install
  "
  pip3 install sbx-rl

  pip3 install "jax[cuda11_cudnn86]" -f https://storage.googleapis.com/jax-releases/jax_cuda_releases.html

  pip3 install dm-control

%runscript
  #!/usr/bin/env bash
  exec python3 /app/pymxs_sbx_run.py $@
